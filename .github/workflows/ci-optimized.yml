name: CI Pipeline (Optimized - Differenzierte Teststrategie)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"
  TEST_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
  TEST_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}
  TEST_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.TEST_SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npm run type-check

      - name: ESLint Check
        run: npm run lint

      - name: Check Code Formatting
        run: |
          if [ "$(npm run lint:fix -- --dry-run 2>&1 | grep -c 'fixable')" -gt 0 ]; then
            echo "âŒ Code formatting issues found. Run 'npm run lint:fix' to fix them."
            exit 1
          else
            echo "âœ… Code formatting is correct."
          fi

  # Job 2: Critical Tests (Lib + Hooks) - HOCHSTE PRIORITÃ„T
  critical-tests:
    name: ðŸ”´ Critical Tests (Lib & Hooks)
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Run Critical Tests
        run: npm run test:critical

      - name: Upload Critical Coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: critical-tests
          name: critical-tests-coverage
          fail_ci_if_error: true

  # Job 3: Component Tests - MITTLERE PRIORITÃ„T
  component-tests:
    name: ðŸŸ¡ Component Tests
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Run Component Tests
        run: npm run test:components

      - name: Upload Component Coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: component-tests
          name: component-tests-coverage
          fail_ci_if_error: false

  # Job 4: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [critical-tests, component-tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Setup Test Database
        run: |
          # Create test database schema
          PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -c "
            CREATE TABLE IF NOT EXISTS campaigns (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              name VARCHAR(255) NOT NULL,
              description TEXT,
              status VARCHAR(50) DEFAULT 'draft',
              created_at TIMESTAMP DEFAULT NOW(),
              updated_at TIMESTAMP DEFAULT NOW()
            );
          "

      - name: Run Integration Tests
        run: npm run test:ci -- --testPathPatterns="__tests__/integration" --coverage
        env:
          TEST_SUPABASE_URL: "http://localhost:54321"
          TEST_SUPABASE_ANON_KEY: "test-anon-key"
          TEST_SUPABASE_SERVICE_ROLE_KEY: "test-service-role-key"

      - name: Upload Integration Test Coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: integration-tests
          name: integration-tests-coverage
          fail_ci_if_error: false

  # Job 5: Build & Type Check - HOCHSTE PRIORITÃ„T
  build:
    name: ðŸ”´ Build Application
    runs-on: ubuntu-latest
    needs: [critical-tests, component-tests, integration-tests]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            .next/
            public/
            package.json
            package-lock.json

  # Job 6: Security Scan - HOCHSTE PRIORITÃ„T
  security-scan:
    name: ðŸ”´ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Run Security Audit
        run: npm audit --audit-level=moderate

  # Job 7: Performance Tests - MITTLERE PRIORITÃ„T
  performance-tests:
    name: ðŸŸ¡ Performance Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Run Performance Tests
        run: npm run test:ci -- --testPathPatterns="__tests__/integration.*performance" --testTimeout=60000

  # Job 8: Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        critical-tests,
        component-tests,
        integration-tests,
        build,
        security-scan,
        performance-tests,
      ]
    if: always()
    steps:
      - name: Generate Test Summary
        run: |
          echo "## ðŸ§ª Differenzierte Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Kategorie | Status | PrioritÃ¤t | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical (Lib + Hooks) | ${{ needs.critical-tests.result }} | ðŸ”´ Hoch | 100%+ |" >> $GITHUB_STEP_SUMMARY
          echo "| Components | ${{ needs.component-tests.result }} | ðŸŸ¡ Mittel | 50%+ |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-tests.result }} | ðŸŸ¡ Mittel | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} | ðŸ”´ Hoch | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-scan.result }} | ðŸ”´ Hoch | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-tests.result }} | ðŸŸ¡ Mittel | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Coverage Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Lib Code**: 100% Coverage (kritisch)" >> $GITHUB_STEP_SUMMARY
          echo "- **Hooks**: 92%+ Coverage (sehr gut)" >> $GITHUB_STEP_SUMMARY
          echo "- **Eigene Komponenten**: 50%+ Coverage (mittlere PrioritÃ¤t)" >> $GITHUB_STEP_SUMMARY
          echo "- **Shadcn UI**: 0% Grenzwerte (niedrige PrioritÃ¤t)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Teststrategie" >> $GITHUB_STEP_SUMMARY
          echo "Fokus auf kritische Bereiche (lib, hooks) mit hohen Coverage-Anforderungen." >> $GITHUB_STEP_SUMMARY
          echo "Moderate Anforderungen fÃ¼r eigene Komponenten, niedrige fÃ¼r Shadcn UI." >> $GITHUB_STEP_SUMMARY
